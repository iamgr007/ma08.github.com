<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
<title>An irrevelant blob</title>
<meta name="description" content="An irrevelant blob">
<meta name="keywords" content="">

<meta property="og:type" content="article">
<meta property="og:title" content="Optimal Proxy Chooser &#8211; ">
<meta property="og:description" content="An irrevelant blob">
<meta property="og:url" content="/Optimal-Proxy-Chooser/">
<meta property="og:site_name" content="">

<!-- Webmaster Tools verfication -->




<link rel="shortcut icon" type="image/png" href="/favicon.png"/>
<link href="/feed.xml" type="application/atom+xml" rel="alternate" title=" Feed">

<meta http-equiv="content-type" content="text/html; charset=utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0" />
<link rel="stylesheet" href="/css/base.css" type="text/css" />
<!--<link rel="stylesheet" href="/css/github.min.css" type="text/css" />-->
<link rel="stylesheet" href="/css/syntax.css" type="text/css" />
<link rel="stylesheet" href="/css/octicons.css" type="text/css" />
<link href='http://fonts.googleapis.com/css?family=Lato' rel='stylesheet' type='text/css'>

</head>
<body>
  <div class="header-container">
  <header>
      <ul class="nav">
        <!--Change the  URL here if working on an absolute domain-->
        <li><a href="/"><span class="mega-octicon octicon-terminal" style="margin-right: 6px;"></span>'BLOB'</a></li>
        <li><a href="/about/"><span class="mega-octicon octicon-person" style="margin-right: 6px;"></span>About</a></li>
        <li><a href="https://github.com/ma08"><span class="mega-octicon octicon-mark-github" style="margin-right: 6px;"></span></a></li>
        <li><a href="http://stackoverflow.com/users/3465519/ma08"><img src="/so-icon.png" width="30" height="30" style="margin-right: 6px;"></a></li>
      </ul>
      <!--
<a href="http://stackoverflow.com/users/3465519/ma08">
<img src="http://stackoverflow.com/users/flair/3465519.png?theme=dark" width="108" height="28" alt="profile for ma08 at Stack Overflow, Q&amp;A for professional and enthusiast programmers" title="profile for ma08 at Stack Overflow, Q&amp;A for professional and enthusiast programmers">
</a>
-->
  </header>
</div>

  <div class="container">
    <p class="intro">
      A clueless, curious programmer's ramblings.
    </p>
  <h2>Optimal Proxy Chooser</h2>
<p class="meta">26 Aug 2014</p>

<div class="post">
<p>I am back to outdo myself at presenting another pointless <code class="inline-code">bash script</code> which has the potential to be a disgrace to the programming community. Maybe this will serve as documentation on how one can get carried away while writing code. </p>

<p>People who access the interwebs behind a <code class="inline-code">proxy-server</code> will know the pain when things get slow and you have no clue which <code class="inline-code">proxy-server</code> will work out and helplessly refer to the stars&#39; alignment to choose a server. When KGP had one of its <a href="http://hotmeme.net/media/i/d/6/r0W-how-cable-companies-think.jpg">We bring you internet from the 90s</a> moments, I had decided that there has got to be a way to choose a proxy based on the bandwidth all the proxies were offering. Either there isn&#39;t any popular service to do that or my googling skills need serious refinement. So I set out to implement a poor man&#39;s method of choosing an optimal <code class="inline-code">proxy-server</code> from a multitude of choices and set that as the <code class="inline-code">System-Wide Proxy</code>. The script is only for <code class="inline-code">Linux</code>.</p>

<p>I have tested this on <code class="inline-code">Ubuntu 14.04</code> (I know it&#39;s not the linuxest of OSes out there, but it rocks my boat). Identifying the optimal <code class="inline-code">proxy-server</code> should work on any Linux distro. Setting the system proxy is specific to <code class="inline-code">Ubuntu</code>. </p>

<p>I used <code class="inline-code">curl</code> to download a test file (I chose a random file of 3MB. Replace the url based on your preferences - be sure to test that the download is working throught curl before using it) and got the request time. Choosing the minimum request time among the options, I selected the optimal server. I haven&#39;t got the faintest of ideas whether this is theoretically the <code class="inline-code">optimal</code> server, but I guess it works for a naive implementation.</p>

<p>Let&#39;s call this <code class="inline-code">proxychooser.sh</code></p>

<div class="highlight"><pre><code class="bash"><span class="nv">minind</span><span class="o">=</span>0 <span class="c">#index for the optimal server</span>
<span class="nv">min</span><span class="o">=</span><span class="s2">&quot;100000.000&quot;</span> <span class="c">#minimum of the request times</span>

<span class="c">#Storing the proxy servers&#39; addresses in an array.</span>
<span class="c">#Bonus points if the you extract the addresses from a config file.</span>
<span class="nv">proxies</span><span class="o">=(</span>
<span class="s2">&quot;http://144.16.192.213:8080&quot;</span>
<span class="s2">&quot;http://144.16.192.216:8080&quot;</span>
<span class="s2">&quot;http://144.16.192.217:8080&quot;</span>
<span class="s2">&quot;http://144.16.192.218:8080&quot;</span>
<span class="s2">&quot;http://144.16.192.245:8080&quot;</span>
<span class="s2">&quot;http://144.16.192.247:8080&quot;</span>
<span class="s2">&quot;http://10.3.100.211:8080&quot;</span>
<span class="s2">&quot;http://10.3.100.212:8080&quot;</span><span class="o">)</span>

<span class="c">#Looping over the array</span>
<span class="k">for</span> <span class="o">((</span> <span class="nv">c</span><span class="o">=</span>0<span class="p">;</span> c&lt;<span class="k">${#</span><span class="nv">proxies</span><span class="p">[@]</span><span class="k">}</span><span class="p">;</span> c++ <span class="o">))</span>
<span class="k">do</span>
<span class="k">    </span><span class="nv">var</span><span class="o">=</span><span class="k">$(</span>curl --no-sessionid -x <span class="s2">&quot;${proxies[c]}&quot;</span>  -o ./proxyfile.pdf -s -w %<span class="o">{</span>time_total<span class="o">}</span><span class="se">\\</span>n http://www.cred.be/download/download.php?file<span class="o">=</span>sites/default/files/CredCrunch15.pdf<span class="k">)</span>
    <span class="c">#var is the request time (string)</span>
    <span class="c"># -x is used to give the proxy to be used</span>
    <span class="c"># proxyfile is the downloaded dummy</span>
    <span class="c"># replace the url with one of your choice</span>
    <span class="nb">echo</span> <span class="k">${</span><span class="nv">proxies</span><span class="p">[c]</span><span class="k">}</span> <span class="nv">$var</span>
    <span class="c">#note that all values are in strings. So using bc for comparisions</span>
    <span class="c"># output is &quot;1&quot; for true and &quot;0&quot; for false</span>
    <span class="nv">var2</span><span class="o">=</span><span class="k">$(</span><span class="nb">echo</span> <span class="s2">&quot;$min &gt; $var&quot;</span> <span class="p">|</span> bc<span class="k">)</span>

    <span class="c"># request time is 0.000 when it is not successful</span>
    <span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$var&quot;</span> !<span class="o">=</span> <span class="s2">&quot;0.000&quot;</span> <span class="o">]&amp;&amp;[</span> <span class="s2">&quot;$var2&quot;</span> <span class="o">==</span> <span class="s2">&quot;1&quot;</span> <span class="o">]</span><span class="p">;</span>
    <span class="k">then</span>
        <span class="c">#saving the current minimum</span>
        <span class="nv">min</span><span class="o">=</span><span class="nv">$var</span>
        <span class="nv">minind</span><span class="o">=</span><span class="nv">$c</span>
    <span class="k">fi</span>
<span class="k">done</span>

<span class="k">if</span> <span class="o">[</span> <span class="s2">&quot;$min&quot;</span> <span class="o">==</span> <span class="s2">&quot;0.000&quot;</span> <span class="o">]</span><span class="p">;</span>
<span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Possible network problems, no connection&quot;</span>
    <span class="k">return </span>0
<span class="k">fi</span>

<span class="nb">echo</span> <span class="s2">&quot;Best proxy is ----&quot;</span> <span class="k">${</span><span class="nv">proxies</span><span class="p">[minind]</span><span class="k">}</span>


<span class="c">#------Insert Ubuntu specific code below--------</span>
</code></pre></div>

<p>This gets the optimal proxy server.</p>

<p>I have toiled over an hour googling to find a generic method to set the <code class="inline-code">System-Wide Http Proxy</code> on <code class="inline-code">Linux</code> which doesn&#39;t involve a restart. Using the enivronment variable <code class="inline-code">http_proxy</code> with <code class="inline-code">export</code> doesn&#39;t work at all as it is restricted to that shell/session. Editing files like <code class="inline-code">/etc/environment</code> didn&#39;t solve anything even when the <code class="inline-code">network-manager</code> is restarted. So I had to go with the <code class="inline-code">Ubuntu</code> specific approach, apologies to all the pure Linuxers out there if you feel let down. </p>

<p>A cool dude helped me  on <a href="http://unix.stackexchange.com/questions/152260/set-ubuntu-system-proxy-settings-without-restart-from-commandline">stackexchange</a> regarding setting the <code class="inline-code">System-Wide Proxy</code> on <code class="inline-code">Ubuntu</code>. Add the following to the end of the above script <code class="inline-code">proxychooser.sh</code>. I have got to admit that I don&#39;t fully understand how the following works, will have to dig into <code class="inline-code">Ubuntu</code>&#39;s documentation sometime.</p>

<p>If you feel this is overkill, you can always manually set your proxy through GUI after getting the optimal server.</p>

<div class="highlight"><pre><code class="bash"><span class="nb">source</span> ./bus.sh
<span class="nv">proxies3</span><span class="o">=(</span>
<span class="s2">&quot;144.16.192.213&quot;</span>
<span class="s2">&quot;144.16.192.216&quot;</span>
<span class="s2">&quot;144.16.192.217&quot;</span>
<span class="s2">&quot;144.16.192.218&quot;</span>
<span class="s2">&quot;144.16.192.245&quot;</span>
<span class="s2">&quot;144.16.192.247&quot;</span>
<span class="s2">&quot;10.3.100.211&quot;</span>
<span class="s2">&quot;10.3.100.212&quot;</span><span class="o">)</span>

<span class="nv">HTTP_PROXY_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">proxies3</span><span class="p">[minind]</span><span class="k">}</span>
<span class="nv">HTTP_PROXY_PORT</span><span class="o">=</span>8080
<span class="nv">HTTPS_PROXY_HOST</span><span class="o">=</span><span class="k">${</span><span class="nv">proxies3</span><span class="p">[minind]</span><span class="k">}</span>
<span class="nv">HTTPS_PROXY_PORT</span><span class="o">=</span>8080

gsettings <span class="nb">set </span>org.gnome.system.proxy.http host <span class="s2">&quot;$HTTP_PROXY_HOST&quot;</span>
gsettings <span class="nb">set </span>org.gnome.system.proxy.http port <span class="s2">&quot;$HTTP_PROXY_PORT&quot;</span>
gsettings <span class="nb">set </span>org.gnome.system.proxy.https host <span class="s2">&quot;$HTTPS_PROXY_HOST&quot;</span>
gsettings <span class="nb">set </span>org.gnome.system.proxy.https port <span class="s2">&quot;$HTTPS_PROXY_PORT&quot;</span>

sudo sed -i.bak <span class="s1">&#39;/http[s]::proxy/Id&#39;</span> /etc/apt/apt.conf
sudo tee -a /etc/apt/apt.conf <span class="s">&lt;&lt;EOF</span>
<span class="s">Acquire::http::proxy &quot;http://$HTTP_PROXY_HOST:$HTTP_PROXY_PORT/&quot;;</span>
<span class="s">Acquire::https::proxy &quot;http://$HTTPS_PROXY_HOST:$HTTPS_PROXY_PORT/&quot;;</span>
<span class="s">EOF</span>

sudo sed -i.bak <span class="s1">&#39;/http[s]_proxy/Id&#39;</span> /etc/environment
sudo tee -a /etc/environment <span class="s">&lt;&lt;EOF</span>
<span class="s">http_proxy=&quot;http://$HTTP_PROXY_HOST:$HTTP_PROXY_PORT/&quot;</span>
<span class="s">https_proxy=&quot;http://$HTTPS_PROXY_HOST:$HTTPS_PROXY_PORT/&quot;</span>
<span class="s">EOF</span>
</code></pre></div>

<p>Save a file <code class="inline-code">bus.sh</code> alongside <code class="inline-code">proxychooser.sh</code>. I got this from <a href="http://askubuntu.com/questions/457016/how-to-change-gsettings-via-remote-shell">stackexchange</a></p>

<div class="highlight"><pre><code class="bash"><span class="c">#!/bin/bash</span>

<span class="c"># Remember to run this script using the command &quot;source ./filename.sh&quot;</span>

<span class="c"># Search these processes for the session variable </span>
<span class="c"># (they are run as the current user and have the DBUS session variable set)</span>
<span class="nv">compatiblePrograms</span><span class="o">=(</span> nautilus kdeinit kded4 pulseaudio trackerd <span class="o">)</span>

<span class="c"># Attempt to get a program pid</span>
<span class="k">for </span>index in <span class="k">${</span><span class="nv">compatiblePrograms</span><span class="p">[@]</span><span class="k">}</span><span class="p">;</span> <span class="k">do</span>
<span class="k">    </span><span class="nv">PID</span><span class="o">=</span><span class="k">$(</span>pidof -s <span class="k">${</span><span class="nv">index</span><span class="k">})</span>
    <span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;${PID}&quot;</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
<span class="k">        </span><span class="nb">break</span>
<span class="nb">    </span><span class="k">fi</span>
<span class="k">done</span>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;${PID}&quot;</span> <span class="o">==</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Could not detect active login session&quot;</span>
    <span class="k">return </span>1
<span class="k">fi</span>

<span class="nv">QUERY_ENVIRON</span><span class="o">=</span><span class="s2">&quot;$(tr &#39;\0&#39; &#39;\n&#39; &lt; /proc/${PID}/environ | grep &quot;</span>DBUS_SESSION_BUS_ADDRESS<span class="s2">&quot; | cut -d &quot;</span><span class="o">=</span><span class="s2">&quot; -f 2-)&quot;</span>
<span class="k">if</span> <span class="o">[[</span> <span class="s2">&quot;${QUERY_ENVIRON}&quot;</span> !<span class="o">=</span> <span class="s2">&quot;&quot;</span> <span class="o">]]</span><span class="p">;</span> <span class="k">then</span>
<span class="k">    </span><span class="nb">export </span><span class="nv">DBUS_SESSION_BUS_ADDRESS</span><span class="o">=</span><span class="s2">&quot;${QUERY_ENVIRON}&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;Connected to session:&quot;</span>
    <span class="nb">echo</span> <span class="s2">&quot;DBUS_SESSION_BUS_ADDRESS=${DBUS_SESSION_BUS_ADDRESS}&quot;</span>
<span class="k">else</span>
<span class="k">    </span><span class="nb">echo</span> <span class="s2">&quot;Could not find dbus session ID in user environment.&quot;</span>
    <span class="k">return </span>1
<span class="k">fi</span>

<span class="k">return </span>0
</code></pre></div>

<p>Make sure both the scripts are executable by <code class="inline-code">sudo chmod +x scriptname.sh</code> and run the <code class="inline-code">proxychooser.sh</code> whenever you feel a need to change the proxy.</p>

<p>Here are the <code class="inline-code">gists</code> for the working scripts. <a href="https://gist.github.com/ma08/94020d6f960378122779">proxychooser.sh</a> and <a href="https://gist.github.com/ma08/2d5126421ca3b288ff43">bus.sh</a></p>

<p>I am counting on this post&#39;s popularity in KGP being minimal. A <code class="inline-code">Game-Theoretic</code> analysis(or common sense) would deduce that the <code class="inline-code">chosen optimal server might no longer be optimal</code> if the majority of the users opt for that server. Don&#39;t disappoint me junta. Be sure to expect some detailed posts on <a href="http://en.wikipedia.org/wiki/Game_theory">Game Theory</a> in the future. Thanks.</p>

<p>Please point out any gaping mistakes or suggest anything that might improve the approach.</p>

</div>

<div class="keep-in-touch">
  <p>
    
  </p>
</div>
<a href="https:/twitter.com/share" class="twitter-share-button" data-via="" data-size="large" data-hashtags="gotchacode">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+':/platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>


<!-- Add Disqus comments. -->

<div id="disqus_thread"></div>
<script type="text/javascript">
  /* * * CONFIGURATION VARIABLES: EDIT BEFORE PASTING INTO YOUR WEBPAGE * * */
  var disqus_shortname = 'sourya4'; // required: replace example with your forum shortname
  var disqus_identifier = '_posts/2014-08-26-Optimal-Proxy-Chooser.md';
  /* * * DON'T EDIT BELOW THIS LINE * * */
  (function() {
    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
  })();
</script>
<noscript>Please enable JavaScript to view the <a href="http:/disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
<a href="http:/disqus.com" class="dsq-brlink">comments powered by <span class="logo-disqus">Disqus</span></a>





  

<script type="text/javascript">
  var _gaq = _gaq || [];
  _gaq.push(['_setAccount', 'UA-51744607-1']);
  _gaq.push(['_trackPageview']);
  (function() {
  var ga = document.createElement('script'); ga.type = 'text/javascript'; ga.async = true;
  ga.src = ('https:' == document.location.protocol ? 'https://ssl' : 'http://www') + '.google-analytics.com/ga.js';
  var s = document.getElementsByTagName('script')[0]; s.parentNode.insertBefore(ga, s);
  })();
</script>

  </div><!-- /.main -->
</body>
</html>